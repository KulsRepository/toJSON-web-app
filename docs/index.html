<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Converter</title>
    <!-- Use Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .container {
            max-width: 800px;
        }
        textarea {
            resize: none;
            height: 200px;
        }
        .drag-over {
            @apply border-indigo-500 bg-indigo-50;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-2xl">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Spreadsheet to JSON Converter</h1>
        <p class="text-center text-gray-600 mb-8">
            Upload a spreadsheet (CSV, Excel, ODS) and provide a JSON template to convert your data.
        </p>

        <form id="convert-form" class="space-y-6">
            <!-- File Input -->
            <div>
                <label for="file-input" class="block text-sm font-medium text-gray-700">Select Spreadsheet File</label>
                <div id="drop-zone" class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md transition duration-300 ease-in-out">
                    <div class="space-y-1 text-center">
                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v12m0 0v12m0-12H20l1.8-3.6A2 2 0 0124 22h8c2.2 0 4-1.8 4-4V8c0-2.2-1.8-4-4-4zm-14 2c-.6-1.2-1.8-2-3.2-2H8c-2.2 0-4 1.8-4 4v20m36-12h-8" />
                        </svg>
                        <div class="flex text-sm text-gray-600">
                            <label for="file-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500">
                                <span>Upload a file</span>
                                <input id="file-upload" name="file" type="file" class="sr-only" accept=".csv, .xls, .xlsx, .ods, .tsv, .fods, .numbers">
                            </label>
                            <p class="pl-1">or drag and drop</p>
                        </div>
                        <p id="file-name" class="text-base font-semibold text-gray-700">No file selected.</p>
                    </div>
                </div>
            </div>

            <!-- JSON Template Input -->
            <div>
                <label for="template-input" class="block text-sm font-medium text-gray-700">Enter JSON Template</label>
                <textarea id="template-input" name="template" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-3" placeholder='Example: {"user_info": {"name": "Name", "email": "Email"}}'></textarea>
            </div>

            <!-- Submit Button -->
            <div>
                <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Convert Data
                </button>
            </div>
        </form>

        <!-- Status Message and Download Link (if applicable) -->
        <div id="status-message" class="mt-6 text-center text-sm font-medium"></div>

        <!-- JSON Output Section -->
        <div id="output-section" class="mt-8 hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">Converted JSON Data</h2>
            <textarea id="output-textarea" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-3" readonly></textarea>
            <div class="mt-4 flex justify-center">
                <button id="download-button" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                    Download JSON File
                </button>
            </div>
        </div>
    </div>

    <script>
        const form = document.getElementById('convert-form');
        const statusMessage = document.getElementById('status-message');
        const fileUpload = document.getElementById('file-upload');
        const templateInput = document.getElementById('template-input');
        const dropZone = document.getElementById('drop-zone');
        const fileNameDisplay = document.getElementById('file-name');
        const outputSection = document.getElementById('output-section');
        const outputTextarea = document.getElementById('output-textarea');
        const downloadButton = document.getElementById('download-button');

        // Event listener for file selection via click
        fileUpload.addEventListener('change', () => {
            if (fileUpload.files.length > 0) {
                fileNameDisplay.textContent = `File selected: ${fileUpload.files[0].name}`;
            } else {
                fileNameDisplay.textContent = 'No file selected.';
            }
        });

        // Event listeners for drag and drop
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileUpload.files = files;
                fileNameDisplay.textContent = `File selected: ${files[0].name}`;
            }
        });

        // Main form submission logic
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Clear previous messages and hide output section
            statusMessage.textContent = 'Converting...';
            statusMessage.className = 'mt-6 text-center text-sm font-medium text-gray-500';
            outputSection.classList.add('hidden');

            const file = fileUpload.files[0];
            const template = templateInput.value;

            if (!file) {
                statusMessage.textContent = 'Please select a file to upload.';
                statusMessage.className = 'mt-6 text-center text-sm font-medium text-red-500';
                return;
            }

            if (!template) {
                statusMessage.textContent = 'Please provide a JSON template.';
                statusMessage.className = 'mt-6 text-center text-sm font-medium text-red-500';
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('template', template);

            try {
                // IMPORTANT: You will need to replace 'YOUR_SERVERLESS_FUNCTION_URL'
                // with the actual URL you get after deploying your Python backend.
                const response = await fetch('https://us-central1-tojson-469714.cloudfunctions.net/convert_to_json', {
                    method: 'POST',
                    body: formData,
                });

                const result = await response.json();

                if (result.success) {
                    const jsonString = JSON.stringify(result.data, null, 4);

                    // Display the JSON data in the textarea
                    outputTextarea.value = jsonString;
                    outputSection.classList.remove('hidden');

                    statusMessage.textContent = 'Conversion successful! Data is displayed below.';
                    statusMessage.className = 'mt-6 text-center text-sm font-medium text-green-500';
                    
                    // Add event listener for the download button
                    downloadButton.onclick = () => {
                        const blob = new Blob([jsonString], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'converted_data.json';
                        document.body.appendChild(a);
                        a.click();
                        
                        // Clean up resources
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    };

                } else {
                    statusMessage.textContent = `Error: ${result.message}`;
                    statusMessage.className = 'mt-6 text-center text-sm font-medium text-red-500';
                    outputSection.classList.add('hidden');
                }
            } catch (error) {
                statusMessage.textContent = `An unexpected error occurred: ${error.message}`;
                statusMessage.className = 'mt-6 text-center text-sm font-medium text-red-500';
                outputSection.classList.add('hidden');
            }
        });
    </script>
</body>
</html>
